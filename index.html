<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI-Powered GBA Emulator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tensor-flow/0.1.0/tf.min.js"></script>
  <style>
    :root {
      --primary: #8A2BE2;
      --secondary: #4B0082;
      --accent: #9370DB;
      --background: #121212;
      --surface: #1E1E1E;
      --text: #E0E0E0;
      --border-radius: 8px;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background);
      color: var(--text);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    h1 {
      font-size: 2.5rem;
      background: linear-gradient(90deg, #FF6B6B, #556270);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 0.5rem;
    }
    
    .subtitle {
      color: #9370DB;
      font-size: 1.2rem;
    }
    
    .emulator-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    
    @media (min-width: 900px) {
      .emulator-container {
        flex-direction: row;
        align-items: flex-start;
      }
    }
    
    .emulator {
      flex: 2;
      background-color: var(--surface);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .controls {
      flex: 1;
      background-color: var(--surface);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    #gameCanvas {
      width: 100%;
      border-radius: var(--border-radius);
      background-color: black;
      image-rendering: pixelated;
    }
    
    .upload-section {
      margin-bottom: 20px;
      padding: 20px;
      border: 2px dashed var(--accent);
      border-radius: var(--border-radius);
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .upload-section:hover {
      border-color: var(--primary);
      background-color: rgba(138, 43, 226, 0.1);
    }
    
    #romUpload {
      display: none;
    }
    
    .upload-label {
      cursor: pointer;
      padding: 10px 20px;
      background-color: var(--primary);
      color: white;
      border-radius: var(--border-radius);
      display: inline-block;
      transition: all 0.3s ease;
    }
    
    .upload-label:hover {
      background-color: var(--secondary);
    }
    
    .button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-bottom: 10px;
    }
    
    .button:hover {
      background-color: var(--secondary);
    }
    
    .button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    
    .control-group {
      margin-bottom: 20px;
    }
    
    .control-group h3 {
      border-bottom: 1px solid var(--accent);
      padding-bottom: 5px;
      margin-bottom: 15px;
    }
    
    .ai-status {
      margin-top: 20px;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: var(--border-radius);
    }
    
    .ai-logs {
      height: 200px;
      overflow-y: auto;
      background-color: #000;
      color: #0F0;
      font-family: monospace;
      padding: 10px;
      border-radius: var(--border-radius);
      margin-top: 10px;
    }
    
    .game-info {
      margin-top: 20px;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .tutorial-panel {
      background-color: var(--surface);
      width: 80%;
      max-width: 600px;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
    
    .close-button {
      float: right;
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .gamepad-visual {
      display: grid;
      grid-template-areas:
        ". up ."
        "left center right"
        ". down .";
      width: 150px;
      margin: 0 auto;
      gap: 5px;
    }
    
    .dpad-button {
      width: 40px;
      height: 40px;
      background-color: #333;
      border-radius: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .dpad-button:active, .dpad-button.active {
      background-color: var(--primary);
    }
    
    .dpad-up { grid-area: up; }
    .dpad-left { grid-area: left; }
    .dpad-center { grid-area: center; visibility: hidden; }
    .dpad-right { grid-area: right; }
    .dpad-down { grid-area: down; }
    
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    
    .action-button {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .action-button:active, .action-button.active {
      background-color: var(--primary);
    }
    
    .action-button.b-button { background-color: #E74C3C; }
    .action-button.a-button { background-color: #2ECC71; }
    
    .action-button.b-button:active, .action-button.b-button.active { background-color: #C0392B; }
    .action-button.a-button:active, .action-button.a-button.active { background-color: #27AE60; }
    
    .shoulder-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .shoulder-button {
      width: 80px;
      height: 30px;
      background-color: #333;
      border-radius: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .shoulder-button:active, .shoulder-button.active {
      background-color: var(--primary);
    }
    
    .center-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    
    .center-button {
      width: 60px;
      height: 25px;
      background-color: #333;
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-size: 0.7rem;
      transition: all 0.2s;
    }
    
    .center-button:active, .center-button.active {
      background-color: var(--primary);
    }
    
    .key-indicator {
      display: inline-block;
      background-color: #333;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 5px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>AI-Powered GBA Emulator</h1>
      <p class="subtitle">Upload your GBA ROM and play or let AI take control</p>
    </header>
    
    <div class="emulator-container">
      <div class="emulator">
        <div class="upload-section">
          <p>Drag & drop your GBA ROM or click to select</p>
          <input type="file" id="romUpload" accept=".gba">
          <label for="romUpload" class="upload-label">Select ROM File</label>
        </div>
        
        <canvas id="gameCanvas" width="240" height="160"></canvas>
        
        <div class="game-info">
          <h3>Game Info</h3>
          <p id="gameTitle">No ROM loaded</p>
          <p id="gameSize"></p>
        </div>
      </div>
      
      <div class="controls">
        <div class="control-group">
          <h3>Emulator Controls</h3>
          <button id="startButton" class="button" disabled>Start Game</button>
          <button id="pauseButton" class="button" disabled>Pause</button>
          <button id="resetButton" class="button" disabled>Reset</button>
          <button id="saveStateButton" class="button" disabled>Save State</button>
          <button id="loadStateButton" class="button" disabled>Load State</button>
        </div>
        
        <div class="control-group">
          <h3>AI Controls</h3>
          <button id="aiPlayButton" class="button" disabled>Let AI Play</button>
          <button id="aiStopButton" class="button" disabled>Stop AI</button>
          <button id="aiTrainButton" class="button" disabled>Train AI</button>
          
          <div class="ai-status">
            <p>AI Status: <span id="aiStatusText">Inactive</span></p>
            <div class="ai-logs" id="aiLogs"></div>
          </div>
        </div>
        
        <div class="control-group">
          <h3>Controller</h3>
          <div class="shoulder-buttons">
            <div class="shoulder-button" id="lButton">L <span class="key-indicator">Q</span></div>
            <div class="shoulder-button" id="rButton">R <span class="key-indicator">E</span></div>
          </div>
          
          <div class="gamepad-visual">
            <div class="dpad-button dpad-up" id="upButton">↑ <span class="key-indicator">W</span></div>
            <div class="dpad-button dpad-left" id="leftButton">← <span class="key-indicator">A</span></div>
            <div class="dpad-button dpad-center"></div>
            <div class="dpad-button dpad-right" id="rightButton">→ <span class="key-indicator">D</span></div>
            <div class="dpad-button dpad-down" id="downButton">↓ <span class="key-indicator">S</span></div>
          </div>
          
          <div class="action-buttons">
            <div class="action-button b-button" id="bButton">B <span class="key-indicator">K</span></div>
            <div class="action-button a-button" id="aButton">A <span class="key-indicator">L</span></div>
          </div>
          
          <div class="center-buttons">
            <div class="center-button" id="selectButton">SELECT <span class="key-indicator">N</span></div>
            <div class="center-button" id="startButtonSmall">START <span class="key-indicator">M</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="overlay" id="tutorialOverlay">
    <div class="tutorial-panel">
      <button class="close-button" id="closeTutorial">×</button>
      <h2>Welcome to the AI-Powered GBA Emulator!</h2>
      <p>This emulator allows you to play your favorite Game Boy Advance games in the browser and even watch an AI learn to play them.</p>
      <h3>Quick Start:</h3>
      <ol>
        <li>Upload your GBA ROM file (.gba)</li>
        <li>Click "Start Game" to begin playing</li>
        <li>Use keyboard controls or the on-screen buttons</li>
        <li>Try the "Let AI Play" button to watch the AI agent play</li>
      </ol>
      <h3>Keyboard Controls:</h3>
      <p>D-Pad: W, A, S, D<br>
      A Button: L<br>
      B Button: K<br>
      L Button: Q<br>
      R Button: E<br>
      Start: M<br>
      Select: N</p>
      <button class="button" id="startTutorial">Got it!</button>
    </div>
  </div>

  <script>
    // Main application code
    document.addEventListener('DOMContentLoaded', function() {
      // DOM elements
      const romUpload = document.getElementById('romUpload');
      const uploadSection = document.querySelector('.upload-section');
      const gameCanvas = document.getElementById('gameCanvas');
      const startButton = document.getElementById('startButton');
      const pauseButton = document.getElementById('pauseButton');
      const resetButton = document.getElementById('resetButton');
      const saveStateButton = document.getElementById('saveStateButton');
      const loadStateButton = document.getElementById('loadStateButton');
      const aiPlayButton = document.getElementById('aiPlayButton');
      const aiStopButton = document.getElementById('aiStopButton');
      const aiTrainButton = document.getElementById('aiTrainButton');
      const aiStatusText = document.getElementById('aiStatusText');
      const aiLogs = document.getElementById('aiLogs');
      const gameTitle = document.getElementById('gameTitle');
      const gameSize = document.getElementById('gameSize');
      const tutorialOverlay = document.getElementById('tutorialOverlay');
      const closeTutorial = document.getElementById('closeTutorial');
      const startTutorial = document.getElementById('startTutorial');

      // Game controller buttons
      const controlButtons = {
        up: document.getElementById('upButton'),
        down: document.getElementById('downButton'),
        left: document.getElementById('leftButton'),
        right: document.getElementById('rightButton'),
        a: document.getElementById('aButton'),
        b: document.getElementById('bButton'),
        l: document.getElementById('lButton'),
        r: document.getElementById('rButton'),
        select: document.getElementById('selectButton'),
        start: document.getElementById('startButtonSmall')
      };

      // Global variables
      let gbaEmulator = null;
      let romData = null;
      let isGameRunning = false;
      let isAIPlaying = false;
      let aiAgent = null;
      let gameLoop = null;
      let currentKeys = new Set();
      let frameBuffer = null;
      let frameCount = 0;
      
      // Close tutorial
      closeTutorial.addEventListener('click', () => {
        tutorialOverlay.style.display = 'none';
      });
      
      startTutorial.addEventListener('click', () => {
        tutorialOverlay.style.display = 'none';
      });

      // Initialize mock GBA emulator
      // In a real implementation, this would use the actual gba.js library
      class GBAEmulator {
        constructor(romData) {
          this.romData = romData;
          this.running = false;
          this.frameBuffer = new Uint8Array(240 * 160 * 4); // RGBA buffer
          this.saveState = null;
          
          // Initialize with random pixels for demo
          for (let i = 0; i < this.frameBuffer.length; i += 4) {
            this.frameBuffer[i] = Math.floor(Math.random() * 255);     // R
            this.frameBuffer[i + 1] = Math.floor(Math.random() * 255); // G
            this.frameBuffer[i + 2] = Math.floor(Math.random() * 255); // B
            this.frameBuffer[i + 3] = 255;                             // A
          }
          
          // Extract ROM info (mock implementation)
          this.romInfo = {
            title: this.extractTitle(),
            size: this.romData.byteLength
          };
        }
        
        extractTitle() {
          // In a real implementation, this would extract the title from the ROM header
          // For demo purposes, we'll use the filename
          if (this.romData.name) {
            return this.romData.name.replace('.gba', '');
          }
          return "Unknown Game";
        }
        
        start() {
          this.running = true;
          this.renderLoop();
        }
        
        pause() {
          this.running = false;
        }
        
        reset() {
          // Reset emulator state
          this.running = false;
          
          // Reinitialize frame buffer with random pixels for demo
          for (let i = 0; i < this.frameBuffer.length; i += 4) {
            this.frameBuffer[i] = Math.floor(Math.random() * 255);     // R
            this.frameBuffer[i + 1] = Math.floor(Math.random() * 255); // G
            this.frameBuffer[i + 2] = Math.floor(Math.random() * 255); // B
            this.frameBuffer[i + 3] = 255;                             // A
          }
        }
        
        renderLoop() {
          if (!this.running) return;
          
          // Update frame buffer
          this.updateFrameBuffer();
          
          // Request next frame
          requestAnimationFrame(() => this.renderLoop());
        }
        
        updateFrameBuffer() {
          // In a real implementation, this would run one frame of the GBA emulation
          // For demo purposes, we'll just modify a few pixels
          for (let i = 0; i < 1000; i++) {
            const idx = Math.floor(Math.random() * (this.frameBuffer.length / 4)) * 4;
            this.frameBuffer[idx] = Math.floor(Math.random() * 255);     // R
            this.frameBuffer[idx + 1] = Math.floor(Math.random() * 255); // G
            this.frameBuffer[idx + 2] = Math.floor(Math.random() * 255); // B
          }
          
          // Render to canvas
          const ctx = gameCanvas.getContext('2d');
          const imgData = new ImageData(new Uint8ClampedArray(this.frameBuffer), 240, 160);
          ctx.putImageData(imgData, 0, 0);
        }
        
        saveCurrentState() {
          // In a real implementation, this would serialize the emulator state
          this.saveState = "Mock save state";
          return true;
        }
        
        loadSavedState() {
          if (!this.saveState) return false;
          // In a real implementation, this would deserialize and load the state
          return true;
        }
        
        setKeys(keys) {
          // In a real implementation, this would set the keys to be pressed
          // keys is a Set of 'up', 'down', 'left', 'right', 'a', 'b', 'l', 'r', 'start', 'select'
          this.currentKeys = keys;
        }
        
        getFrame() {
          // In a real implementation, this would return the current frame data
          return this.frameBuffer;
        }
      }
      
      // AI Agent implementation
      class AIAgent {
        constructor(emulator) {
          this.emulator = emulator;
          this.isActive = false;
          this.model = null;
          this.isTrained = false;
          
          // For demo purposes, we'll use a simple pattern of actions
          this.actionPatterns = [
            new Set(['right', 'b']),
            new Set(['right']),
            new Set(['right', 'a']),
            new Set(['right']),
            new Set(['right', 'b']),
            new Set(['up']),
            new Set(['up', 'a']),
            new Set(['left']),
            new Set(['left', 'b']),
            new Set(['down']),
            new Set(['down', 'a']),
            new Set(['right'])
          ];
          this.currentPatternIndex = 0;
          this.frameCounter = 0;
        }
        
        async train() {
          aiStatusText.textContent = "Training...";
          addAILog("Starting AI training...");
          
          // Simulate training progress
          for (let i = 0; i < 5; i++) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            addAILog(`Training progress: ${(i+1)*20}%`);
          }
          
          this.isTrained = true;
          aiStatusText.textContent = "Trained";
          addAILog("AI training complete! The agent has learned basic game patterns.");
          return true;
        }
        
        start() {
          if (!this.isTrained) {
            addAILog("WARNING: Starting untrained AI. Performance may be random.");
          }
          
          this.isActive = true;
          aiStatusText.textContent = "Active";
          addAILog("AI agent started");
          
          // Reset counters
          this.currentPatternIndex = 0;
          this.frameCounter = 0;
        }
        
        stop() {
          this.isActive = false;
          aiStatusText.textContent = this.isTrained ? "Trained" : "Inactive";
          addAILog("AI agent stopped");
        }
        
        getNextAction() {
          if (!this.isActive) return new Set();
          
          // Simple pattern-based AI for demo
          // In a real implementation, this would use the model to predict actions
          this.frameCounter++;
          
          // Change pattern every 60 frames (about 1 second)
          if (this.frameCounter >= 60) {
            this.frameCounter = 0;
            this.currentPatternIndex = (this.currentPatternIndex + 1) % this.actionPatterns.length;
            
            // Log every few pattern changes
            if (this.currentPatternIndex % 3 === 0) {
              const actionNames = Array.from(this.actionPatterns[this.currentPatternIndex]).join('+');
              addAILog(`AI decision: ${actionNames || 'wait'}`);
            }
          }
          
          return this.actionPatterns[this.currentPatternIndex];
        }
      }
      
      // Helper function to add a log entry to the AI log
      function addAILog(message) {
        const logEntry = document.createElement('div');
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        aiLogs.appendChild(logEntry);
        aiLogs.scrollTop = aiLogs.scrollHeight;
      }
      
      // File upload handling
      romUpload.addEventListener('change', handleFileSelect);
      uploadSection.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadSection.style.borderColor = 'var(--primary)';
        uploadSection.style.backgroundColor = 'rgba(138, 43, 226, 0.1)';
      });
      
      uploadSection.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadSection.style.borderColor = 'var(--accent)';
        uploadSection.style.backgroundColor = '';
      });
      
      uploadSection.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadSection.style.borderColor = 'var(--accent)';
        uploadSection.style.backgroundColor = '';
        
        if (e.dataTransfer.files.length > 0) {
          const file = e.dataTransfer.files[0];
          if (file.name.endsWith('.gba')) {
            romUpload.files = e.dataTransfer.files;
            handleFileSelect(e);
          } else {
            alert('Please upload a valid GBA ROM file (.gba)');
          }
        }
      });
      
      function handleFileSelect(event) {
        const file = event.target.files[0] || event.dataTransfer.files[0];
        
        if (!file) return;
        if (!file.name.endsWith('.gba')) {
          alert('Please upload a valid GBA ROM file (.gba)');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          romData = e.target.result;
          
          // Add the file name to the romData object for reference
          romData.name = file.name;
          
          // Update UI to show file info
          gameTitle.textContent = file.name;
          gameSize.textContent = `Size: ${(file.size / (1024 * 1024)).toFixed(2)} MB`;
          
          // Enable start button
          startButton.disabled = false;
          resetButton.disabled = false;
          
          // Update upload section
          uploadSection.style.borderColor = 'var(--primary)';
          document.querySelector('.upload-section p').textContent = `ROM loaded: ${file.name}`;
        };
        
        reader.readAsArrayBuffer(file);
      }
      
      // Button event handlers
      startButton.addEventListener('click', () => {
        if (!romData) {
          alert('Please upload a ROM file first');
          return;
        }
        
        if (!gbaEmulator) {
          gbaEmulator = new GBAEmulator(romData);
          
          // Initialize AI agent
          aiAgent = new AIAgent(gbaEmulator);
          
          // Update UI with ROM info
          gameTitle.textContent = gbaEmulator.romInfo.title;
          gameSize.textContent = `Size: ${(gbaEmulator.romInfo.size / (1024 * 1024)).toFixed(2)} MB`;
          
          // Enable all buttons
          pauseButton.disabled = false;
          saveStateButton.disabled = false;
          loadStateButton.disabled = false;
          aiPlayButton.disabled = false;
          aiTrainButton.disabled = false;
        }
        
        // Start emulation
        gbaEmulator.start();
        isGameRunning = true;
        
        // Update button states
        startButton.disabled = true;
        pauseButton.disabled = false;
        
        // Start game loop
        startGameLoop();
      });
      
      pauseButton.addEventListener('click', () => {
        if (!gbaEmulator || !isGameRunning) return;
        
        gbaEmulator.pause();
        isGameRunning = false;
        
        // Update button states
        startButton.disabled = false;
        pauseButton.disabled = true;
        
        // Stop game loop
        stopGameLoop();
      });
      
      resetButton.addEventListener('click', () => {
        if (!gbaEmulator) return;
        
        // Stop AI if running
        if (isAIPlaying && aiAgent) {
          aiAgent.stop();
          isAIPlaying = false;
          aiPlayButton.disabled = false;
          aiStopButton.disabled = true;
        }
        
        gbaEmulator.reset();
        isGameRunning = false;
        
        // Update button states
        startButton.disabled = false;
        pauseButton.disabled = true;
        
        // Stop game loop
        stopGameLoop();
      });
      
      saveStateButton.addEventListener('click', () => {
        if (!gbaEmulator) return;
        
        if (gbaEmulator.saveCurrentState()) {
          loadStateButton.disabled = false;
          addAILog("Game state saved");
        }
      });
      
      loadStateButton.addEventListener('click', () => {
        if (!gbaEmulator) return;
        
        if (gbaEmulator.loadSavedState()) {
          addAILog("Game state loaded");
          if (!isGameRunning) {
            startButton.disabled = false;
          }
        }
      });
      
      aiPlayButton.addEventListener('click', () => {
        if (!gbaEmulator || !aiAgent) return;
        
        // Start AI
        aiAgent.start();
        isAIPlaying = true;
        
        // Update button states
        aiPlayButton.disabled = true;
        aiStopButton.disabled = false;
        
        // If game is not running, start it
        if (!isGameRunning) {
          gbaEmulator.start();
          isGameRunning = true;
          startButton.disabled = true;
          pauseButton.disabled = false;
          startGameLoop();
        }
      });
      
      aiStopButton.addEventListener('click', () => {
        if (!aiAgent) return;
        
        // Stop AI
        aiAgent.stop();
        isAIPlaying = false;
        
        // Update button states
        aiPlayButton.disabled = false;
        aiStopButton.disabled = true;
        
        // Clear all active buttons
        currentKeys.clear();
        updateButtonVisuals();
      });
      
      aiTrainButton.addEventListener('click', async () => {
        if (!aiAgent) return;
        
        // Disable buttons during training
        aiTrainButton.disable
