<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GBA Web Emulator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2a2a2a;
            color: #fff;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 {
            color: #8bc34a;
            margin-bottom: 20px;
        }
        .emulator-container {
            position: relative;
            width: 480px;
            height: 320px;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
        canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 480px;
        }
        .file-input {
            margin-bottom: 15px;
            width: 100%;
            display: flex;
            justify-content: space-between;
        }
        .buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            width: 100%;
            margin-bottom: 20px;
        }
        button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #4caf50;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #45a049;
        }
        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            width: 150px;
            margin-bottom: 20px;
        }
        .d-pad button {
            background-color: #3f51b5;
        }
        .d-pad button:hover {
            background-color: #303f9f;
        }
        .d-pad .empty {
            background-color: transparent;
        }
        .status {
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 14px;
            width: 100%;
            max-width: 480px;
        }
        .key-guide {
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 14px;
            width: 100%;
            max-width: 480px;
        }
        .key-guide h3 {
            margin-top: 0;
            color: #8bc34a;
        }
        .key-guide ul {
            padding-left: 20px;
        }
        #fps-counter {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
        #debug-log {
            width: 100%;
            max-width: 480px;
            height: 100px;
            overflow-y: auto;
            background-color: #1a1a1a;
            color: #4caf50;
            font-family: monospace;
            font-size: 12px;
            padding: 5px;
            border-radius: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>GBA Web Emulator</h1>
    
    <div class="emulator-container">
        <canvas id="gba-screen"></canvas>
        <div id="fps-counter">0 FPS</div>
    </div>
    
    <div class="controls">
        <div class="file-input">
            <input type="file" id="rom-input" accept=".gba">
            <button id="load-rom">Load ROM</button>
            <button id="toggle-play">Play/Pause</button>
        </div>
        
        <div class="buttons">
            <button id="btn-a">A</button>
            <button id="btn-b">B</button>
            <button id="btn-select">SELECT</button>
            <button id="btn-start">START</button>
            <button id="btn-l">L</button>
            <button id="btn-r">R</button>
        </div>
        
        <div class="d-pad">
            <div class="empty"></div>
            <button id="btn-up">UP</button>
            <div class="empty"></div>
            <button id="btn-left">LEFT</button>
            <div class="empty"></div>
            <button id="btn-right">RIGHT</button>
            <div class="empty"></div>
            <button id="btn-down">DOWN</button>
            <div class="empty"></div>
        </div>
    </div>
    
    <div class="status" id="status">Status: No ROM loaded</div>
    
    <div class="key-guide">
        <h3>Keyboard Controls</h3>
        <ul>
            <li>Arrow Keys: D-Pad</li>
            <li>Z: A Button</li>
            <li>X: B Button</li>
            <li>A: L Button</li>
            <li>S: R Button</li>
            <li>Enter: Start</li>
            <li>Shift: Select</li>
            <li>Space: Pause/Resume</li>
        </ul>
    </div>
    
    <div id="debug-log"></div>

    <script>
        // ======= GBA Constants =======
        const GBA = {
            SCREEN_WIDTH: 240,
            SCREEN_HEIGHT: 160,
            CYCLES_PER_SECOND: 16777216, // CPU speed: ~16.78 MHz
            CYCLES_PER_FRAME: 280896,    // Cycles per frame at 60 FPS
            
            // Memory regions
            BIOS_START: 0x00000000,
            EWRAM_START: 0x02000000,
            IWRAM_START: 0x03000000,
            IO_START: 0x04000000,
            PALETTE_START: 0x05000000,
            VRAM_START: 0x06000000,
            OAM_START: 0x07000000,
            ROM_START: 0x08000000,
            
            // Memory sizes
            BIOS_SIZE: 16 * 1024,         // 16 KB
            EWRAM_SIZE: 256 * 1024,       // 256 KB
            IWRAM_SIZE: 32 * 1024,        // 32 KB
            PALETTE_SIZE: 1 * 1024,       // 1 KB
            VRAM_SIZE: 96 * 1024,         // 96 KB
            OAM_SIZE: 1 * 1024,           // 1 KB
            ROM_SIZE_MAX: 32 * 1024 * 1024, // 32 MB max
            
            // Hardware registers
            REG_DISPCNT: 0x04000000,      // Display Control
            REG_VCOUNT: 0x04000006,       // Vertical Counter
            REG_BG0CNT: 0x04000008,       // BG0 Control
            REG_BG1CNT: 0x0400000A,       // BG1 Control
            REG_BG2CNT: 0x0400000C,       // BG2 Control
            REG_BG3CNT: 0x0400000E,       // BG3 Control
            REG_KEYINPUT: 0x04000130,     // Key Input
            
            // Display Control flags
            DISPCNT_BG0_ENABLE: 0x0100,
            DISPCNT_BG1_ENABLE: 0x0200,
            DISPCNT_BG2_ENABLE: 0x0400,
            DISPCNT_BG3_ENABLE: 0x0800,
            DISPCNT_OBJ_ENABLE: 0x1000,
            
            // Key Input values (0 = pressed, 1 = released)
            KEY_A: 0x0001,
            KEY_B: 0x0002,
            KEY_SELECT: 0x0004,
            KEY_START: 0x0008,
            KEY_RIGHT: 0x0010,
            KEY_LEFT: 0x0020,
            KEY_UP: 0x0040,
            KEY_DOWN: 0x0080,
            KEY_R: 0x0100,
            KEY_L: 0x0200
        };

        // ======= Emulator Class =======
        class GBAEmulator {
            constructor() {
                // Canvas setup
                this.canvas = document.getElementById('gba-screen');
                this.canvas.width = GBA.SCREEN_WIDTH;
                this.canvas.height = GBA.SCREEN_HEIGHT;
                this.ctx = this.canvas.getContext('2d');
                this.imageData = this.ctx.createImageData(GBA.SCREEN_WIDTH, GBA.SCREEN_HEIGHT);
                
                // Emulator state
                this.running = false;
                this.frameCount = 0;
                this.targetFps = 60;
                this.lastFrameTime = 0;
                this.fpsCounter = document.getElementById('fps-counter');
                this.statusElement = document.getElementById('status');
                this.debugLog = document.getElementById('debug-log');
                this.frameTimeAvg = 0;
                this.frameTimeCount = 0;
                
                // Initialize memory
                this.memory = {
                    bios: new Uint8Array(GBA.BIOS_SIZE),
                    ewram: new Uint8Array(GBA.EWRAM_SIZE),
                    iwram: new Uint8Array(GBA.IWRAM_SIZE),
                    io: new Uint16Array(1024), // IO registers
                    palette: new Uint16Array(512), // 512 colors (256 BG, 256 OBJ)
                    vram: new Uint8Array(GBA.VRAM_SIZE),
                    oam: new Uint16Array(512), // Object Attribute Memory
                    rom: new Uint8Array(GBA.ROM_SIZE_MAX)
                };
                
                // CPU state
                this.cpu = {
                    r: new Uint32Array(16), // r0-r15 (r15 is PC)
                    cpsr: 0, // Current Program Status Register
                    spsr: 0, // Saved Program Status Register
                    mode: 0, // CPU mode
                    inThumb: false, // Thumb mode
                    halted: false, // CPU halted
                    cycles: 0, // Cycle counter
                    irqDisabled: true // IRQ disabled
                };
                
                // Input state - these are inverted (0 = pressed, 1 = released)
                this.input = 0xFFFF;
                
                // ROM info
                this.romTitle = "";
                this.romSize = 0;
                this.romLoaded = false;
                this.romGameCode = "";
                
                // Initialize with empty BIOS
                this.initializeBIOS();
                
                // Set up input handlers
                this.setupInputHandlers();
                
                // Register the ROM loader
                document.getElementById('load-rom').addEventListener('click', () => this.loadROM());
                document.getElementById('toggle-play').addEventListener('click', () => this.toggleEmulation());
                
                // Log initialization
                this.log("GBA Emulator initialized");
            }
            
            // ======= Initialization Methods =======
            
            // Initialize BIOS (simple implementation)
            initializeBIOS() {
                // In a real emulator, we would include the actual BIOS, but for this demo
                // we'll just use a simple stub that jumps to the ROM entry point
                
                // The real GBA BIOS is copyrighted by Nintendo, so we use a minimal implementation
                
                // SWI handler (at 0x08)
                this.memory.bios[0x08] = 0x12; // bx r14 (return from SWI)
                this.memory.bios[0x09] = 0xFF;
                this.memory.bios[0x0A] = 0x2F;
                this.memory.bios[0x0B] = 0xE1;
                
                // IRQ handler (at 0x18)
                this.memory.bios[0x18] = 0x12; // bx r14 (return from IRQ)
                this.memory.bios[0x19] = 0xFF;
                this.memory.bios[0x1A] = 0x2F;
                this.memory.bios[0x1B] = 0xE1;
                
                // Reset code (at 0x00)
                this.memory.bios[0x00] = 0x00; // mov r0, #0
                this.memory.bios[0x01] = 0x00;
                this.memory.bios[0x02] = 0xA0;
                this.memory.bios[0x03] = 0xE3;
                
                this.memory.bios[0x04] = 0x00; // b 0x08000000 (ROM entry point)
                this.memory.bios[0x05] = 0x00;
                this.memory.bios[0x06] = 0x00;
                this.memory.bios[0x07] = 0xEA;
            }
            
            // ======= ROM Loading =======
            
            // Load a ROM file
            loadROM() {
                const fileInput = document.getElementById('rom-input');
                const file = fileInput.files[0];
                
                if (!file) {
                    this.updateStatus("Error: No file selected");
                    return;
                }
                
                if (file.size > GBA.ROM_SIZE_MAX) {
                    this.updateStatus(`Error: ROM too large (${file.size} bytes, max is ${GBA.ROM_SIZE_MAX} bytes)`);
                    return;
                }
                
                this.updateStatus("Loading ROM...");
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const romData = new Uint8Array(e.target.result);
                    
                    // Copy ROM data to memory
                    this.memory.rom.set(romData);
                    this.romSize = romData.length;
                    
                    // Extract ROM header information
                    this.parseROMHeader(romData);
                    
                    // Reset emulator
                    this.reset();
                    
                    // Start emulation
                    this.romLoaded = true;
                    this.startEmulation();
                    
                    this.updateStatus(`ROM loaded: ${this.romTitle} (${this.romGameCode}) - ${this.romSize} bytes`);
                    this.log(`ROM loaded: ${this.romTitle} (${this.romGameCode})`);
                };
                
                reader.onerror = () => {
                    this.updateStatus("Error: Failed to read ROM file");
                };
                
                reader.readAsArrayBuffer(file);
            }
            
            // Parse ROM header
            parseROMHeader(rom) {
                // Game title: 12 bytes at offset 0xA0
                let title = "";
                for (let i = 0; i < 12; i++) {
                    const char = rom[0xA0 + i];
                    if (char === 0) break;
                    title += String.fromCharCode(char);
                }
                this.romTitle = title.trim();
                
                // Game code: 4 bytes at offset 0xAC
                let gameCode = "";
                for (let i = 0; i < 4; i++) {
                    gameCode += String.fromCharCode(rom[0xAC + i]);
                }
                this.romGameCode = gameCode;
                
                // Log ROM info
                this.log(`ROM Title: ${this.romTitle}`);
                this.log(`Game Code: ${this.romGameCode}`);
                this.log(`ROM Size: ${this.romSize} bytes`);
            }
            
            // ======= Emulation Control =======
            
            // Reset emulator state
            reset() {
                // Reset memory
                this.memory.ewram.fill(0);
                this.memory.iwram.fill(0);
                this.memory.io.fill(0);
                this.memory.palette.fill(0);
                this.memory.vram.fill(0);
                this.memory.oam.fill(0);
                
                // Reset CPU
                this.cpu.r.fill(0);
                this.cpu.r[13] = 0x03007F00; // SP_irq
                this.cpu.r[15] = 0x08000000; // PC starts at ROM
                this.cpu.cpsr = 0x1F; // System mode
                this.cpu.spsr = 0;
                this.cpu.mode = 0x1F; // System mode
                this.cpu.inThumb = false; // ARM mode
                this.cpu.halted = false;
                this.cpu.cycles = 0;
                this.cpu.irqDisabled = true;
                
                // Reset timers
                this.frameCount = 0;
                this.lastFrameTime = 0;
            }
            
            // Start emulation
            startEmulation() {
                if (!this.running && this.romLoaded) {
                    this.running = true;
                    this.lastFrameTime = performance.now();
                    this.frameTimeAvg = 0;
                    this.frameTimeCount = 0;
                    requestAnimationFrame((timestamp) => this.emulationLoop(timestamp));
                    this.log("Emulation started");
                    this.updateStatus(`Running: ${this.romTitle}`);
                }
            }
            
            // Stop emulation
            stopEmulation() {
                this.running = false;
                this.log("Emulation paused");
                this.updateStatus(`Paused: ${this.romTitle}`);
            }
            
            // Toggle emulation
            toggleEmulation() {
                if (this.running) {
                    this.stopEmulation();
                } else {
                    this.startEmulation();
                }
            }
            
            // ======= Main Emulation Loop =======
            
            // Main emulation loop
            emulationLoop(timestamp) {
                if (!this.running) return;
                
                // Calculate time since last frame
                const deltaTime = timestamp - this.lastFrameTime;
                this.lastFrameTime = timestamp;
                
                // Calculate FPS
                if (this.frameTimeCount < 30) {
                    this.frameTimeAvg += deltaTime;
                    this.frameTimeCount++;
                } else {
                    const fps = Math.round(1000 / (this.frameTimeAvg / 30));
                    this.fpsCounter.textContent = `${fps} FPS`;
                    this.frameTimeAvg = deltaTime;
                    this.frameTimeCount = 1;
                }
                
                // Run CPU for one frame's worth of cycles
                this.runFrame();
                
                // Render screen
                this.renderScreen();
                
                // Update frame counter
                this.frameCount++;
                
                // Continue the loop
                requestAnimationFrame((timestamp) => this.emulationLoop(timestamp));
            }
            
            // Run one frame of emulation
            runFrame() {
                const cyclesToRun = GBA.CYCLES_PER_FRAME;
                
                // Process input
                this.updateInputRegister();
                
                // Execute instructions
                this.executeInstructions(cyclesToRun);
            }
            
            // Execute a number of cycles
            executeInstructions(cycles) {
                let cyclesExecuted = 0;
                
                while (cyclesExecuted < cycles && !this.cpu.halted) {
                    // In a real emulator, we would fetch, decode, and execute
                    // actual ARM/Thumb instructions. For this simplified version,
                    // we'll increment PC and simulate some memory access
                    
                    // Increment PC by 4 (ARM) or 2 (Thumb)
                    this.cpu.r[15] += this.cpu.inThumb ? 2 : 4;
                    
                    // Keep PC in valid memory range
                    if (this.cpu.r[15] >= GBA.ROM_START + this.romSize) {
                        this.cpu.r[15] = GBA.ROM_START; // Loop back to start of ROM
                    }
                    
                    // Simulate instruction execution
                    cyclesExecuted += this.cpu.inThumb ? 1 : 2;
                    
                    // Occasionally switch between ARM and Thumb for demonstration
                    if (Math.random() < 0.001) {
                        this.cpu.inThumb = !this.cpu.inThumb;
                    }
                }
                
                this.cpu.cycles += cyclesExecuted;
                
                // Handle VBLANK (occurs at end of frame)
                this.memory.io[GBA.REG_VCOUNT - GBA.IO_START] = 160; // VCOUNT 160 = VBLANK
            }
            
            // ======= Memory Access =======
            
            // Read a 32-bit word from memory
            readWord(address) {
                const region = address >>> 24;
                const offset = address & 0xFFFFFF;
                
                switch (region) {
                    case 0x00: // BIOS
                        if (offset < GBA.BIOS_SIZE) {
                            return (this.memory.bios[offset] | 
                                    (this.memory.bios[offset + 1] << 8) | 
                                    (this.memory.bios[offset + 2] << 16) | 
                                    (this.memory.bios[offset + 3] << 24)) >>> 0;
                        }
                        break;
                        
                    case 0x02: // EWRAM
                        if (offset < GBA.EWRAM_SIZE) {
                            return (this.memory.ewram[offset] | 
                                    (this.memory.ewram[offset + 1] << 8) | 
                                    (this.memory.ewram[offset + 2] << 16) | 
                                    (this.memory.ewram[offset + 3] << 24)) >>> 0;
                        }
                        break;
                        
                    case 0x03: // IWRAM
                        if (offset < GBA.IWRAM_SIZE) {
                            return (this.memory.iwram[offset] | 
                                    (this.memory.iwram[offset + 1] << 8) | 
                                    (this.memory.iwram[offset + 2] << 16) | 
                                    (this.memory.iwram[offset + 3] << 24)) >>> 0;
                        }
                        break;
                        
                    case 0x04: // IO
                        if (offset < 0x400) {
                            const ioOffset = offset >>> 1;
                            return (this.memory.io[ioOffset] | (this.memory.io[ioOffset + 1] << 16)) >>> 0;
                        }
                        break;
                        
                    case 0x05: // Palette
                        if (offset < GBA.PALETTE_SIZE) {
                            const paletteOffset = offset >>> 1;
                            return (this.memory.palette[paletteOffset] | (this.memory.palette[paletteOffset + 1] << 16)) >>> 0;
                        }
                        break;
                        
                    case 0x06: // VRAM
                        if (offset < GBA.VRAM_SIZE) {
                            return (this.memory.vram[offset] | 
                                    (this.memory.vram[offset + 1] << 8) | 
                                    (this.memory.vram[offset + 2] << 16) | 
                                    (this.memory.vram[offset + 3] << 24)) >>> 0;
                        }
                        break;
                        
                    case 0x07: // OAM
                        if (offset < GBA.OAM_SIZE) {
                            const oamOffset = offset >>> 1;
                            return (this.memory.oam[oamOffset] | (this.memory.oam[oamOffset + 1] << 16)) >>> 0;
                        }
                        break;
                        
                    case 0x08: case 0x09: case 0x0A: case 0x0B:
                    case 0x0C: case 0x0D: // ROM
                        const romOffset = address - GBA.ROM_START;
                        if (romOffset < this.romSize) {
                            return (this.memory.rom[romOffset] | 
                                    (this.memory.rom[romOffset + 1] << 8) | 
                                    (this.memory.rom[romOffset + 2] << 16) | 
                                    (this.memory.rom[romOffset + 3] << 24)) >>> 0;
                        }
                        break;
                }
                
                // Default for unmapped memory
                return 0xFFFFFFFF;
            }
            
            // Write a 32-bit word to memory
            writeWord(address, value) {
                const region = address >>> 24;
                const offset = address & 0xFFFFFF;
                
                switch (region) {
                    case 0x02: // EWRAM
                        if (offset < GBA.EWRAM_SIZE) {
                            this.memory.ewram[offset] = value & 0xFF;
                            this.memory.ewram[offset + 1] = (value >>> 8) & 0xFF;
                            this.memory.ewram[offset + 2] = (value >>> 16) & 0xFF;
                            this.memory.ewram[offset + 3] = (value >>> 24) & 0xFF;
                        }
                        break;
                        
                    case 0x03: // IWRAM
                        if (offset < GBA.IWRAM_SIZE) {
                            this.memory.iwram[offset] = value & 0xFF;
                            this.memory.iwram[offset + 1] = (value >>> 8) & 0xFF;
                            this.memory.iwram[offset + 2] = (value >>> 16) & 0xFF;
                            this.memory.iwram[offset + 3] = (value >>> 24) & 0xFF;
                        }
                        break;
                        
                    case 0x04: // IO
                        if (offset < 0x400) {
                            const ioOffset = offset >>> 1;
                            this.memory.io[ioOffset] = value & 0xFFFF;
                            this.memory.io[ioOffset + 1] = (value >>> 16) & 0xFFFF;
                            this.handleIOWrite(address, value);
                        }
                        break;
                        
                    case 0x05: // Palette
                        if (offset < GBA.PALETTE_SIZE) {
                            const paletteOffset = offset >>> 1;
                            this.memory.palette[paletteOffset] = value & 0xFFFF;
                            this.memory.palette[paletteOffset + 1] = (value >>> 16) & 0xFFFF;
                        }
                        break;
                        
                    case 0x06: // VRAM
                        if (offset < GBA.VRAM_SIZE) {
                            this.memory.vram[offset] = value & 0xFF;
                            this.memory.vram[offset + 1] = (value >>> 8) & 0xFF;
                            this.memory.vram[offset + 2] = (value >>> 16) & 0xFF;
                            this.memory.vram[offset + 3] = (value >>> 24) & 0xFF;
                        }
                        break;
                        
                    case 0x07: // OAM
                        if (offset < GBA.OAM_SIZE) {
                            const oamOffset = offset >>> 1;
                            this.memory.oam[oamOffset] = value & 0xFFFF;
                            this.memory.oam[oamOffset + 1] = (value >>> 16) & 0xFFFF;
                        }
                        break;
                }
            }
            
            // Handle writes to IO registers
            handleIOWrite(address, value) {
                // In a real emulator, we would need to handle all the different IO registers
                
                // Handle display control register
                if (address === GBA.REG_DISPCNT) {
                    this.log(`Set DISPCNT to 0x${value.toString(16).padStart(8, '0')}`);
                }
            }
            
            // ======= Input Handling =======
            
            // Update the key input register
            updateInputRegister() {
                // Write inverted input state to the key input register
                this.memory.io[(GBA.REG_KEYINPUT - GBA.IO_START) >>> 1] = this.input;
            }
            
            // Set up input handlers for keyboard and buttons
            setupInputHandlers() {
                // Keyboard controls
                document.addEventListener('keydown', (e) => {
                    this.handleKeyInput(e.key, true);
                    e.preventDefault();
                });
                
                document.addEventListener('keyup', (e) => {
                    this.handleKeyInput(e.key, false);
                    e.preventDefault();
                });
                
                // On-screen button controls
                const buttons = {
                    'btn-a': GBA.KEY_A,
                    'btn-b': GBA.KEY_B,
                    'btn-select': GBA.KEY_SELECT,
                    'btn-start': GBA.KEY_START,
                    'btn-up': GBA.KEY_UP,
                    'btn-down': GBA.KEY_DOWN,
                    'btn-left': GBA.KEY_LEFT,
                    'btn-right': GBA.KEY_RIGHT,
                    'btn-l': GBA.KEY_L,
                    'btn-r': GBA.KEY_R
                };
                
                Object.entries(buttons).forEach(([btnId, keyFlag]) => {
                    const btn = document.getElementById(btnId);
                    
                    btn.addEventListener('mousedown', () => {
                        this.input &= ~keyFlag; // Set bit to 0 (pressed)
                    });
                    
                    btn.addEventListener('mouseup', () => {
                        this.input |= keyFlag; // Set bit to 1 (released)
                    });
                    
                    btn.addEventListener('touchstart', (e) => {
                        this.input &= ~keyFlag;
                        e.preventDefault();
                    });
                    
                    btn.addEventListener('touchend', (e) => {
                        this.input |= keyFlag;
                        e.preventDefault();
                    });
                });
            }
            
            // Handle keyboard input
            handleKeyInput(key, isPressed) {
                let keyFlag = 0;
                
                switch (key.toLowerCase()) {
                    case 'z': keyFlag = GBA.KEY_A; break;
                    case 'x': keyFlag = GBA.KEY_B; break;
                    case 'shift': keyFlag = GBA.KEY_SELECT; break;
                    case 'enter': keyFlag = GBA.KEY_START; break;
                    case 'arrowup': keyFlag = GBA.KEY_UP; break;
                    case 'arrowdown': keyFlag = GBA.KEY_DOWN; break;
                    case 'arrowleft': keyFlag = GBA.KEY_LEFT; break;
                    case 'arrowright': keyFlag = GBA.KEY_RIGHT; break;
                    case 'a': keyFlag = GBA.KEY_L; break;
                    case 's': keyFlag = GBA.KEY_R; break;
                    case ' ':
                        // Toggle emulation on spacebar press
                        if (isPressed) {
                            this.toggleEmulation();
                        }
                        return;
                }
                
                if (keyFlag !== 0) {
                    if (isPressed) {
                        this.input &= ~keyFlag; // Set bit to 0 (pressed)
                    } else {
                        this.input |= keyFlag; // Set bit to 1 (released)
                    }
                }
            }
            
            // ======= Graphics Rendering =======
            
            // Render the screen
            renderScreen() {
                const data = this.imageData.data;
                
                // In a real emulator, we would render based on VRAM content and display mode
                // For this simplified version, we'll just visualize memory in a way that shows
                // something interesting on the screen
                
                // Display mode flags
                const dispCnt = this.memory.io[(GBA.REG_DISPCNT - GBA.IO_START) >>> 1];
                const bg0Enabled = (dispCnt & GBA.DISPCNT_BG0_ENABLE) !== 0;
                const bg1Enabled = (dispCnt & GBA.DISPCNT_BG1_ENABLE) !== 0;
                const bg2Enabled = (dispCnt & GBA.DISPCNT_BG2_ENABLE) !== 0;
                const bg3Enabled = (dispCnt & GBA.DISPCNT_BG3_ENABLE) !== 0;
                const objEnabled = (dispCnt & GBA.DISPCNT_OBJ_ENABLE) !== 0;
                
                // Render visualization of memory
                for (let y = 0; y < GBA.SCREEN_HEIGHT; y++) {
                    for (let x = 0; x < GBA.SCREEN_WIDTH; x++) {
                        const pixelIndex = (y * GBA.SCREEN_WIDTH + x) * 4;
                        
                        // Create a visual representation based on memory contents
                        // This doesn't actually render real GBA graphics but simulates
                        // what memory visualization might look like
                        
                        // Sample different memory regions based on position
                        const vramOffset = ((y * 4) % GBA.VRAM_SIZE) + (x % 240);
                        const paletteOffset = ((x + y) % 512);
                        const ewramOffset = ((x * y) % GBA.EWRAM_SIZE);
                        
                        // Sample memory contents
                        const vramValue = this.memory.vram[vramOffset];
                        const paletteValue = this.memory.palette[paletteOffset % 512];
                        const ewramValue = this.memory.ewram[ewramOffset];
                        
                        // Use these to create a visual pattern
                        if (bg0Enabled && x < GBA.SCREEN_WIDTH / 2 && y < GBA.SCREEN_HEIGHT / 2) {
                            // Top-left: VRAM visualization
                            data[pixelIndex] = vramValue;
                            data[pixelIndex + 1] = vramValue;
                            data[pixelIndex + 2] = 255;
                            data[pixelIndex + 3] = 255;
                        } else if (bg1Enabled && x >= GBA.SCREEN_WIDTH / 2 && y < GBA.SCREEN_HEIGHT / 2) {
                            // Top-right: Palette visualization
                            const r = paletteValue & 0x1F;
                            const g = (paletteValue >> 5) & 0x1F;
                            const b = (paletteValue >> 10) & 0x1F;
                            data[pixelIndex] = r << 3;
                            data[pixelIndex + 1] = g << 3;
                            data[pixelIndex + 2] = b << 3;
                            data[pixelIndex + 3] = 255;
                        } else if (bg2Enabled && x < GBA.SCREEN_WIDTH / 2 && y >= GBA.SCREEN_HEIGHT / 2) {
                            // Bottom-left: ROM visualization
                            const romPos = (y * GBA.SCREEN_WIDTH + x) % this.romSize;
                            const romValue = this.memory.rom[romPos];
                            data[pixelIndex] = 0;
                            data[pixelIndex + 1] = romValue;
                            data[pixelIndex + 2] = 0;
                            data[pixelIndex + 3] = 255;
                        } else if (bg3Enabled && x >= GBA.SCREEN_WIDTH / 2 && y >= GBA.SCREEN_HEIGHT / 2) {
                            // Bottom-right: EWRAM visualization
                            data[pixelIndex] = 255;
                            data[pixelIndex + 1] = 0;
                            data[pixelIndex + 2] = ewramValue;
                            data[pixelIndex + 3] = 255;
                        } else {
                            // Default: black
                            data[pixelIndex] = 0;
                            data[pixelIndex + 1] = 0;
                            data[pixelIndex + 2] = 0;
                            data[pixelIndex + 3] = 255;
                        }
                        
                        // If sprites are enabled, add some "sprites"
                        if (objEnabled) {
                            // Create some "sprite" animations that move with the frame counter
                            const spriteSize = 16;
                            const spriteX = (this.frameCount * 2) % (GBA.SCREEN_WIDTH - spriteSize);
                            const spriteY = 50;
                            
                            // Draw a simple sprite
                            if (x >= spriteX && x < spriteX + spriteSize && 
                                y >= spriteY && y < spriteY + spriteSize) {
                                
                                const relX = x - spriteX;
                                const relY = y - spriteY;
                                
                                // Create a pattern for the sprite
                                if ((relX + relY) % 2 === 0) {
                                    data[pixelIndex] = 255;
                                    data[pixelIndex + 1] = 0;
                                    data[pixelIndex + 2] = 0;
                                    data[pixelIndex + 3] = 255;
                                }
                            }
                            
                            // Add another sprite that moves in a circle
                            const angle = this.frameCount * 0.05;
                            const circleX = Math.floor(GBA.SCREEN_WIDTH / 2 + Math.cos(angle) * 60);
                            const circleY = Math.floor(GBA.SCREEN_HEIGHT / 2 + Math.sin(angle) * 40);
                            
                            if (Math.abs(x - circleX) < 8 && Math.abs(y - circleY) < 8) {
                                data[pixelIndex] = 255;
                                data[pixelIndex + 1] = 255;
                                data[pixelIndex + 2] = 0;
                                data[pixelIndex + 3] = 255;
                            }
                        }
                    }
                }
                
                // Put the image data onto the canvas
                this.ctx.putImageData(this.imageData, 0, 0);
                
                // Add some debug info as overlay
                this.ctx.fillStyle = 'rgba(0,0,0,0.5)';
                this.ctx.fillRect(0, 0, 160, 15);
                this.ctx.fillStyle = '#FFFFFF';
                this.ctx.font = '10px monospace';
                this.ctx.fillText(`PC: 0x${this.cpu.r[15].toString(16).padStart(8, '0')}`, 5, 10);
            }
            
            // ======= Utility Methods =======
            
            // Update status display
            updateStatus(message) {
                this.statusElement.textContent = `Status: ${message}`;
            }
            
            // Add a log message
            log(message) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString();
                const logElement = document.createElement('div');
                logElement.textContent = `[${timeStr}] ${message}`;
                this.debugLog.appendChild(logElement);
                this.debugLog.scrollTop = this.debugLog.scrollHeight;
                
                // Keep log size reasonable
                while (this.debugLog.childNodes.length > 100) {
                    this.debugLog.removeChild(this.debugLog.firstChild);
                }
            }
        }

        // Create and initialize the emulator when the page loads
        window.addEventListener('load', () => {
            window.gbaEmulator = new GBAEmulator();
        });
