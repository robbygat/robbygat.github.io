<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Privacy Poker</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="https://unpkg.com/pokersolver@2.2.0/dist/pokersolver.min.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      :root {
        --primary-color: #00ffff;
        --secondary-color: #ff0066;
        --bg-dark: #0a0a0a;
        --table-green: #1a3c34;
        --font-family: 'Orbitron', sans-serif;
      }
      body {
        font-family: var(--font-family);
        background-color: var(--bg-dark);
        color: var(--primary-color);
        overflow-x: hidden;
      }
      #particles-js {
        position: fixed;
        width: 100%;
        height: 100%;
        z-index: -1;
        background: var(--bg-dark);
      }
      header {
        position: fixed;
        top: 0;
        width: 100%;
        padding: 15px 30px;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
        border-bottom: 1px solid var(--secondary-color);
      }
      header h2 {
        font-size: 1.8rem;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      header a {
        color: var(--primary-color);
        text-decoration: none;
        font-size: 1.2rem;
        transition: color 0.3s;
      }
      header a:hover {
        color: var(--secondary-color);
      }
      .game-ui {
        padding-top: 80px;
        min-height: 100vh;
        position: relative;
      }
      .table {
        width: 80%;
        height: 70vh;
        margin: 50px auto;
        background: var(--table-green);
        border-radius: 20px;
        border: 2px solid var(--secondary-color);
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      }
      .table::before {
        content: "poker";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Orbitron" font-size="100" fill="rgba(255,255,255,0.1)">poker</text></svg>');
        background-size: cover;
        pointer-events: none;
      }
      .community {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        gap: 15px;
      }
      .player {
        position: absolute;
        text-align: center;
        padding: 10px;
        transition: all 0.3s;
      }
      .player.active {
        box-shadow: 0 0 15px var(--secondary-color);
      }
      .player.p1 { bottom: 20px; left: 50%; transform: translateX(-50%); }
      .player.p2 { top: 50%; left: 20px; transform: translateY(-50%); }
      .player.p3 { top: 20px; left: 50%; transform: translateX(-50%); }
      .player.p4 { top: 50%; right: 20px; transform: translateY(-50%); }
      .card {
        width: 80px;
        height: 120px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
      }
      .card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .card.hidden {
        background: #1a1a1a;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--secondary-color);
        font-size: 2rem;
      }
      .controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px 20px;
        border-radius: 25px;
        border: 1px solid var(--primary-color);
      }
      .controls button {
        padding: 10px 20px;
        background: transparent;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .controls button:hover {
        background: var(--secondary-color);
        color: #000;
        border-color: var(--secondary-color);
      }
      .game-info {
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        padding: 15px 30px;
        border-radius: 10px;
        border: 1px solid var(--primary-color);
        font-size: 1.2rem;
      }
      .stats {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 10px;
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    <div id="particles-js"></div>
    <header>
      <a href="#" aria-label="Home"><i class="fas fa-home"></i></a>
      <h2>Privacy Poker</h2>
    </header>
    <div id="root"></div>

    <script>
      particlesJS("particles-js", {
        particles: {
          number: { value: 100, density: { enable: true, value_area: 800 } },
          color: { value: "#ff0066" },
          shape: { type: "circle" },
          opacity: { value: 0.5 },
          size: { value: 3, random: true },
          line_linked: {
            enable: true,
            distance: 150,
            color: "#ff0066",
            opacity: 0.4,
            width: 1
          },
          move: { enable: true, speed: 3 }
        },
        interactivity: {
          detect_on: "canvas",
          events: {
            onhover: { enable: true, mode: "repulse" },
            onclick: { enable: true, mode: "push" }
          }
        }
      });
    </script>

    <script type="text/babel">
      const { useState, useEffect } = React;

      const PokerGame = () => {
        const [deckId, setDeckId] = useState(null);
        const [players, setPlayers] = useState({});
        const [community, setCommunity] = useState([]);
        const [stage, setStage] = useState("pre-flop");
        const [pot, setPot] = useState(0);
        const [currentPlayer, setCurrentPlayer] = useState(1);
        const [message, setMessage] = useState("Starting new hand...");
        const [handCount, setHandCount] = useState(0);

        const numPlayers = 4;
        const initialBalance = 1000;
        const smallBlind = 10;
        const bigBlind = 20;

        // Initialize deck using Deck of Cards API
        useEffect(() => {
          fetch("https://deckofcardsapi.com/api/deck/new/shuffle/?deck_count=1")
            .then(res => res.json())
            .then(data => setDeckId(data.deck_id))
            .then(() => startNewHand());
        }, []);

        const startNewHand = async () => {
          if (!deckId) return;

          // Draw cards for players and blinds
          const newPlayers = {};
          const response = await fetch(`https://deckofcardsapi.com/api/deck/${deckId}/draw/?count=${numPlayers * 2 + 5}`);
          const data = await response.json();
          const cards = data.cards;

          for (let i = 1; i <= numPlayers; i++) {
            newPlayers[i] = {
              hand: cards.slice((i-1)*2, i*2),
              balance: players[i]?.balance ?? initialBalance,
              active: true,
              bet: 0,
              totalBet: 0
            };
          }

          // Set blinds
          const smallBlindPlayer = 2;
          const bigBlindPlayer = 3;
          newPlayers[smallBlindPlayer].balance -= smallBlind;
          newPlayers[smallBlindPlayer].bet = smallBlind;
          newPlayers[smallBlindPlayer].totalBet = smallBlind;
          newPlayers[bigBlindPlayer].balance -= bigBlind;
          newPlayers[bigBlindPlayer].bet = bigBlind;
          newPlayers[bigBlindPlayer].totalBet = bigBlind;

          setPlayers(newPlayers);
          setCommunity([]);
          setPot(smallBlind + bigBlind);
          setStage("pre-flop");
          setCurrentPlayer(4);
          setHandCount(prev => prev + 1);
          setMessage("Pre-flop betting round");
        };

        const dealCommunity = async (count) => {
          const response = await fetch(`https://deckofcardsapi.com/api/deck/${deckId}/draw/?count=${count}`);
          const data = await response.json();
          setCommunity(prev => [...prev, ...data.cards]);
          
          if (count === 3) setStage("flop");
          else if (count === 1 && stage === "flop") setStage("turn");
          else if (count === 1 && stage === "turn") setStage("river");
        };

        const currentBet = () => Math.max(...Object.values(players).map(p => p.bet));

        const handleAction = async (action, raiseAmount = 0) => {
          const newPlayers = { ...players };
          const player = newPlayers[currentPlayer];
          
          if (action === "fold") {
            player.active = false;
            setMessage(`Player ${currentPlayer} folds`);
          } else if (action === "call") {
            const toCall = currentBet() - player.bet;
            player.balance -= toCall;
            player.bet += toCall;
            player.totalBet += toCall;
            setPot(prev => prev + toCall);
            setMessage(`Player ${currentPlayer} calls`);
          } else if (action === "raise") {
            const totalBet = currentBet() + raiseAmount;
            const toRaise = totalBet - player.bet;
            player.balance -= toRaise;
            player.bet = totalBet;
            player.totalBet += toRaise;
            setPot(prev => prev + toRaise);
            setMessage(`Player ${currentPlayer} raises to ${totalBet}`);
          }

          setPlayers(newPlayers);
          await nextTurn();
        };

        const nextTurn = async () => {
          const activePlayers = Object.entries(players).filter(([_, p]) => p.active);
          if (activePlayers.every(([_, p]) => p.bet === currentBet())) {
            resetBets();
            if (stage === "pre-flop") await dealCommunity(3);
            else if (stage === "flop") await dealCommunity(1);
            else if (stage === "turn") await dealCommunity(1);
            else if (stage === "river") await showdown();
            setCurrentPlayer(1);
          } else {
            setCurrentPlayer(prev => (prev % numPlayers) + 1);
          }
        };

        const resetBets = () => {
          const newPlayers = { ...players };
          Object.values(newPlayers).forEach(p => p.bet = 0);
          setPlayers(newPlayers);
        };

        const showdown = () => {
          const activePlayers = Object.entries(players).filter(([_, p]) => p.active);
          const hands = activePlayers.map(([id, p]) => ({
            id,
            hand: PokerSolver.Hand.solve([...p.hand, ...community].map(c => c.code))
          }));
          
          const winner = hands.reduce((best, current) => 
            best.hand.compare(current.hand) > 0 ? best : current
          );
          
          const newPlayers = { ...players };
          newPlayers[winner.id].balance += pot;
          setPlayers(newPlayers);
          setMessage(`Player ${winner.id} wins ${pot} with ${winner.hand.descr}`);
          setTimeout(startNewHand, 3000);
        };

        const Card = ({ card, hidden }) => (
          <div className={`card ${hidden ? 'hidden' : ''}`}>
            {hidden ? "??" : <img src={card.image} alt={`${card.value} of ${card.suit}`} />}
          </div>
        );

        return (
          <div className="game-ui">
            <div className="stats">
              Hand: {handCount} | Pot: {pot}
            </div>
            <div className="table">
              <div className="community">
                {community.map((card, idx) => <Card key={idx} card={card} />)}
              </div>
              {Object.entries(players).map(([id, p]) => (
                <div key={id} className={`player p${id} ${currentPlayer === parseInt(id) ? 'active' : ''}`}>
                  <div>Player {id} {id === "1" && "(You)"}</div>
                  <div style={{ display: 'flex', gap: '5px' }}>
                    {p.hand.map((card, idx) => (
                      <Card key={idx} card={card} hidden={id !== "1" && stage !== "river"} />
                    ))}
                  </div>
                  <div>Balance: {p.balance}</div>
                </div>
              ))}
            </div>
            {message && <div className="game-info">{message}</div>}
            {currentPlayer === 1 && (
              <div className="controls">
                <button onClick={() => handleAction("fold")}>Fold</button>
                <button onClick={() => handleAction("call")}>Call</button>
                <button onClick={() => {
                  const amount = parseInt(prompt("Raise amount:", "50")) || 50;
                  handleAction("raise", amount);
                }}>Raise</button>
                <button onClick={startNewHand}>New Hand</button>
              </div>
            )}
          </div>
        );
      };

      ReactDOM.render(<PokerGame />, document.getElementById('root'));
    </script>
  </body>
</html>
